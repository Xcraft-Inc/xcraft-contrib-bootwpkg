From 69c9584a7e6c1379a98d9b24098120614c071a55 Mon Sep 17 00:00:00 2001
From: Mathieu Schroeter <mathieu@schroetersa.ch>
Date: Sun, 1 May 2016 12:05:09 +0200
Subject: [PATCH 3/4] Fix build for Clang

---
 wpkg/CMakeLists.txt                                | 24 ++++++++++++++++++----
 wpkg/controlled_vars/controlled_vars.cpp           |  6 +++---
 .../libdebpackages/tcp_client_server.h             |  1 +
 .../libdebpackages/wpkg_dependencies.h             |  1 +
 wpkg/libdebpackages/libdebpackages/wpkg_filename.h |  1 +
 5 files changed, 26 insertions(+), 7 deletions(-)

diff --git a/wpkg/CMakeLists.txt b/wpkg/CMakeLists.txt
index ba19736..c30a94c 100644
--- a/wpkg/CMakeLists.txt
+++ b/wpkg/CMakeLists.txt
@@ -98,9 +98,17 @@ if( UNIX )
         message( FATAL_ERROR "Unknown architecture '${ARCH}'!" )
     endif()
     if( DEFINED ENV{WPKG_COVERAGE} )
-		set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -O0 -Werror -Wall -Wextra -pedantic -std=c++11 -Wcast-align -Wcast-qual -Wctor-dtor-privacy -Wdisabled-optimization -Winit-self -Wlogical-op -Wmissing-include-dirs -Woverloaded-virtual -Wredundant-decls -Wshadow -Wsign-promo -Wstrict-null-sentinel -Wstrict-overflow=1 -Wundef -Wno-unused -Wunused-variable -Wno-variadic-macros -Wno-parentheses -Wno-unknown-pragmas -Wwrite-strings -Wswitch -fdiagnostics-show-option -fprofile-arcs -ftest-coverage" )
+        set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -O0 -Wall -Wextra -pedantic -std=c++1y -Wcast-align -Wcast-qual -Wctor-dtor-privacy -Wdisabled-optimization -Winit-self -Wmissing-include-dirs -Woverloaded-virtual -Wredundant-decls -Wshadow -Wsign-promo -Wstrict-overflow=1 -Wundef -Wno-unused -Wunused-variable -Wno-variadic-macros -Wno-parentheses -Wno-unknown-pragmas -Wwrite-strings -Wswitch -fdiagnostics-show-option -fprofile-arcs -ftest-coverage" )
+        if ( NOT ${CMAKE_CXX_COMPILER_ID} MATCHES Clang )
+            set ( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wlogical-op -Wstrict-null-sentinel")
+        else()
+            set ( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -stdlib=libc++")
+        endif()
         if( NOT MO_CYGWIN AND NOT MO_SUNOS )
-            set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wnoexcept -Wold-style-cast -Wformat=2" )
+            set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wold-style-cast -Wformat=2" )
+            if ( NOT ${CMAKE_CXX_COMPILER_ID} MATCHES Clang )
+                set ( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wnoexcept")
+            endif()
         endif()
         set( CMAKE_C_FLAGS "-g -O0 -Wall -Wextra -fprofile-arcs -ftest-coverage" )
         set( CMAKE_SHARED_LINKER_FLAGS "-fprofile-arcs -ftest-coverage" )
@@ -110,9 +118,17 @@ if( UNIX )
         # Feel free to comment out this line if you don't like the warnings
         # HOWEVER: do not submit code to us if it generates warnings!
         # You may want to keep the -O3 though
-		set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Werror -Wall -Wextra -pedantic -std=c++11 -Wcast-align -Wcast-qual -Wctor-dtor-privacy -Wdisabled-optimization -Winit-self -Wlogical-op -Wmissing-include-dirs -Woverloaded-virtual -Wredundant-decls -Wshadow -Wsign-promo -Wstrict-null-sentinel -Wstrict-overflow=1 -Wundef -Wno-unused -Wunused-variable -Wno-variadic-macros -Wno-parentheses -Wno-unknown-pragmas -Wwrite-strings -Wswitch -fdiagnostics-show-option" )
+        set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -pedantic -std=c++1y -Wcast-align -Wcast-qual -Wctor-dtor-privacy -Wdisabled-optimization -Winit-self -Wmissing-include-dirs -Woverloaded-virtual -Wredundant-decls -Wshadow -Wsign-promo -Wstrict-overflow=1 -Wundef -Wno-unused -Wunused-variable -Wno-variadic-macros -Wno-parentheses -Wno-unknown-pragmas -Wwrite-strings -Wswitch -fdiagnostics-show-option" )
+        if ( NOT ${CMAKE_CXX_COMPILER_ID} MATCHES Clang )
+            set ( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wlogical-op -Wstrict-null-sentinel")
+        else()
+            set ( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -stdlib=libc++")
+        endif()
         if( NOT MO_CYGWIN AND NOT MO_SUNOS )
-            set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wnoexcept -Wold-style-cast -Wformat=2" )
+            set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wold-style-cast -Wformat=2" )
+            if ( NOT ${CMAKE_CXX_COMPILER_ID} MATCHES Clang )
+                set ( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wnoexcept")
+            endif()
         endif()
         set( OPT "-O3" )
         if( MO_DARWIN )
diff --git a/wpkg/controlled_vars/controlled_vars.cpp b/wpkg/controlled_vars/controlled_vars.cpp
index 76d0873..4523faa 100644
--- a/wpkg/controlled_vars/controlled_vars.cpp
+++ b/wpkg/controlled_vars/controlled_vars.cpp
@@ -108,9 +108,9 @@ types_t const g_types[] =
     { "float",         "float",       "double",        FLAG_TYPE_FLOAT, 0 },
     { "double",        "double",      "double",        FLAG_TYPE_FLOAT, 0 }, /* "long double" would be problematic here */
     { "long double",   "longdouble",  "long double",   FLAG_TYPE_FLOAT, 0 },
-    // The following were for Apple computers with a PPC
-    //{ "size_t",        "size",        "uint64_t",      FLAG_TYPE_INT,   "#ifdef __APPLE__" },
-    //{ "time_t",        "time",        "int64_t",       FLAG_TYPE_INT,   "#ifdef __APPLE__" }
+    // The following were for Apple computers with a PPC and for Clang
+    { "size_t",        "size",        "uint64_t",      FLAG_TYPE_INT,   "#ifdef __clang__" },
+    { "time_t",        "time",        "int64_t",       FLAG_TYPE_INT,   "#ifdef __clang__" }
 };
 #define TYPES_ALL   (sizeof(g_types) / sizeof(g_types[0]))
 
diff --git a/wpkg/libdebpackages/libdebpackages/tcp_client_server.h b/wpkg/libdebpackages/libdebpackages/tcp_client_server.h
index 11b2f9c..eb36808 100644
--- a/wpkg/libdebpackages/libdebpackages/tcp_client_server.h
+++ b/wpkg/libdebpackages/libdebpackages/tcp_client_server.h
@@ -27,6 +27,7 @@
  * remote data.
  */
 
+#include <string>
 #if defined(MO_WINDOWS)
 #include <winsock2.h>
 #else
diff --git a/wpkg/libdebpackages/libdebpackages/wpkg_dependencies.h b/wpkg/libdebpackages/libdebpackages/wpkg_dependencies.h
index c50e7ed..4a6a867 100644
--- a/wpkg/libdebpackages/libdebpackages/wpkg_dependencies.h
+++ b/wpkg/libdebpackages/libdebpackages/wpkg_dependencies.h
@@ -34,6 +34,7 @@
 #include    "controlled_vars/controlled_vars_limited_auto_enum_init.h"
 #include    <stdexcept>
 #include    <vector>
+#include    <string>
 
 
 namespace wpkg_dependencies
diff --git a/wpkg/libdebpackages/libdebpackages/wpkg_filename.h b/wpkg/libdebpackages/libdebpackages/wpkg_filename.h
index 2aacf61..51f08de 100644
--- a/wpkg/libdebpackages/libdebpackages/wpkg_filename.h
+++ b/wpkg/libdebpackages/libdebpackages/wpkg_filename.h
@@ -38,6 +38,7 @@
 #include    <memory>
 #include    <stdexcept>
 #include    <vector>
+#include    <string>
 
 namespace wpkg_filename
 {
-- 
2.8.1

